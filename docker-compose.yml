version: "3.7"

services:  
  gluetun:
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add: 
      - NET_ADMIN
    network_mode: carbolytics
    ports:
      - 8888:8888/tcp # HTTP proxy
      - 8388:8388/tcp # Shadowsocks
      - 8388:8388/udp # Shadowsocks
      - 8000:8000/tcp # Built-in HTTP control server
    environment:
      # Sensitive variables are hidden
      VPNSP: protonvpn
      OPENVPN_USER: GAQ1jBMYRN6dVa7w
      OPENVPN_PASSWORD: 8VjI0VSr83zA33AyyaFImJx6KYs2oJla
      # Regular variables
      FREE_ONLY: "yes"
      SERVER_NAME: "US-FREE#1"
      TZ: "Europe"
    restart: always

  carbolytics:
    build: .
    container_name: crawl
    network_mode: service:gluetun
    environment: 
      DATE: "2021-09-01"
      N_WEBS: 1000000
      N_BROWSERS: 50
    volumes: 
      - type: volume
        source: temp
        target: /opt/data
    depends_on:
      gluetun:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '15'
          memory: 75GB

  database:
    image: postgres
    container_name: carbolytics_db
    network_mode: service:gluetun
    restart: always
    environment:
      POSTGRES_USER: data
      POSTGRES_PASSWORD: dataviz
      POSTGRES_DB: carbolytics
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes: 
      - type: bind
        source: ./sql/tables.sql
        target: /docker-entrypoint-initdb.d/tables.sql
      - type: volume
        source: data
        target: /var/lib/postgresql/data

volumes: 
  data:
    driver: local
    name: carbolytics_db
    driver_opts: 
      type: none
      o: bind
      device: /media/HDD/carbolytics

  temp:
    driver: local
    name: carbolytics_temp
    driver_opts: 
      type: none
      o: bind
      device: /media/M2/stebf/carbolytics